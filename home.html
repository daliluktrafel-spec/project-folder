<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ù…Ù†ØµØ© Ù…ØªØ§Ø¬Ø± Ø§Ù„Ø¨Ù„Ø§Ø¯</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
    margin: 0;
    font-family: "Segoe UI", Tahoma, Arial, sans-serif;
    background: linear-gradient(
        to bottom,
        #f7f6f2 0%,
        #2c2f4a 25%,
        #1b1e33 75%,
        #f7f6f2 100%
    );
    color: #2b2b2b;
}

.header {
    background: linear-gradient(45deg,#c9b36a,#b89b4a,#e6d38a);
    padding: 20px;
    text-align: center;
    font-size: 24px;
    font-weight: bold;
    color: #1b1e33;
    position: relative;
}

.fav-top {
    position: absolute;
    left: 15px;
    top: 15px;
    background: white;
    color: #b89b4a;
    padding: 6px 12px;
    border-radius: 20px;
    font-weight: bold;
    cursor: pointer;
}

.categories {
    display: flex;
    gap: 10px;
    padding: 15px;
    overflow-x: auto;
}

.category-btn {
    flex: 0 0 auto;
    min-width: 110px;
    background: white;
    border: 2px solid #b89b4a;
    border-radius: 12px;
    padding: 10px;
    font-weight: bold;
    font-size: 15px;
    cursor: pointer;
    white-space: nowrap;
    color: #1b1e33;
}
.category-btn:hover {
    background: linear-gradient(45deg,#c9b36a,#b89b4a);
    color: #1b1e33;
}

@media (max-width: 600px) {
    .category-btn {
        min-width: 80px;
        padding: 6px;
        font-size: 12px;
    }
}

.container {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
    padding: 20px;
}

.card {
    background: white;
    border-radius: 15px;
    padding: 12px;
    text-align: center;
    box-shadow: 0 8px 20px rgba(0,0,0,0.2);
    cursor: pointer;
    display: flex;
    flex-direction: column;
}

.product-img {
    width: 100%;
    aspect-ratio: 1 / 1;
    border-radius: 12px;
    background-size: contain;
    background-position: center;
    background-repeat: no-repeat;
    margin-bottom: 8px;
}

.product-name { font-weight: bold; font-size: 15px; }
.product-price { color: #b89b4a; font-weight: bold; }
.product-store { color: #3f4a7a; font-size: 14px; }
.product-status { color: #7a6a3a; font-size: 13px; }

.tabs {
    display: flex;
    justify-content: center;
    gap: 10px;
    padding: 15px;
    position: fixed;
    bottom: 0;
    width: 100%;
    background: #ffffffcc;
}

.tab {
    padding: 10px 20px;
    border-radius: 12px;
    border: 2px solid #b89b4a;
    font-weight: bold;
    background: #f7f6f2;
    cursor: pointer;
    color: #1b1e33;
}

.tab.active {
    background: linear-gradient(45deg,#c9b36a,#b89b4a);
    color: #1b1e33;
}
</style>
</head>

<body>

<div class="header" id="welcome">
    Ù…Ø±Ø­Ø¨Ø§ Ø¨Ùƒ
    <div class="fav-top" onclick="showFavorites()">â¤ï¸ <span id="favCount">0</span></div>
</div>

<div id="categories" class="categories"></div>

<div style="padding:15px;text-align:center;">
    <input
        type="text"
        id="searchInput"
        placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬ Ø£Ùˆ Ù…ØªØ¬Ø±..."
        onkeyup="smartSearch()"
        style="width:90%;max-width:400px;padding:12px;border-radius:12px;"
    >
</div>

<div id="favorites" class="container" style="display:none;"></div>
<div id="all" class="container"></div>
<div id="available" class="container" style="display:none;"></div>
<div id="stores" class="container" style="display:none;"></div>

<div class="tabs">
    <div class="tab active" onclick="showSection('all',this)">ÙƒÙ„ Ø§Ù„Ø¨Ø¶Ø§Ø¦Ø¹</div>
    <div class="tab" onclick="showSection('available',this)">Ø§Ù„Ù…ØªÙˆÙØ±</div>
    <div class="tab" onclick="showSection('stores',this)">Ø§Ù„Ù…ØªØ§Ø¬Ø±</div>
</div>

<!-- Ù…Ù„ÙØ§Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ø¨Ø­Ø« -->
<script src="products.js"></script>
<script src="dictionary.js"></script>
<script src="search-dictionary.js"></script>

<script>
const userName = localStorage.getItem("userName") || "Ù…Ø³ØªØ®Ø¯Ù…";
const userRegion = localStorage.getItem("userRegion") || "";
document.getElementById("welcome").firstChild.nodeValue =
`Ù…Ø±Ø­Ø¨Ù‹Ø§ ${userName} ${userRegion}`;

let favorites = JSON.parse(localStorage.getItem("favorites") || "[]");
document.getElementById("favCount").innerText = favorites.length;

function filterByCategory(key){
    showSection("all");
    renderProducts("all", p => p.category === key);
}

/* ===============================
   AVAILABILITY LOGIC (Ù…ØªÙˆÙØ±)
================================ */
function isAvailable(product) {
    const status = normalizeArabic(product.status || "");

    // ÙÙ‚Ø· "ØºÙŠØ± Ù…ØªÙˆÙØ±" ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¹Ø§Ø¯Ù‡
    if (status.includes("ØºÙŠØ± Ù…ØªÙˆÙØ±")) return false;

    // Ù…ØªÙˆÙØ± + ÙƒÙ…ÙŠØ© Ù…Ø­Ø¯ÙˆØ¯Ø© + Ù…ØªØ¨Ù‚ÙŠ = Ù…ØªÙˆÙØ±
    return true;
}

function shortName(text, max = 45){
    return text.length > max ? text.slice(0, max) + "â€¦" : text;
}

const storesList = [...new Set(products.map(p => p.store))];

function renderProducts(containerId, filter = () => true){
    const c = document.getElementById(containerId);
    c.innerHTML = "";
    products.filter(filter).forEach(p=>{
        const d = document.createElement("div");
        d.className = "card";

        d.innerHTML = `
            <div class="product-img" style="background-image:url('${p.image}')"></div>
            <div class="product-name">${shortName(p.name)}</div>
            <div class="product-price">${p.price}</div>
            <div class="product-store">${p.store}</div>
            <div class="product-status">${p.status}</div>
            <button class="fav-btn" style="margin-top:5px;padding:5px;border:none;border-radius:10px;cursor:pointer;">
                â¤ï¸ ${favorites.includes(p.id) ? 'Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù…ÙØ¶Ù„Ø©' : 'Ø£Ø¶Ù Ù„Ù„Ù…ÙØ¶Ù„Ø©'}
            </button>
        `;

        d.onclick = (e)=>{
            if(e.target.tagName !== 'BUTTON'){
                location.href=`product.html?productId=${p.id}`;
            }
        };

        const btn = d.querySelector(".fav-btn");
        btn.onclick = (e)=>{
            e.stopPropagation();
            if(favorites.includes(p.id)){
                favorites = favorites.filter(fid=>fid!==p.id);
            } else {
                favorites.push(p.id);
            }
            localStorage.setItem("favorites", JSON.stringify(favorites));
            document.getElementById("favCount").innerText = favorites.length;
            renderProducts(containerId, filter);
        };

        c.appendChild(d);
    });
}

function renderStores(){
    const c = document.getElementById("stores");
    c.innerHTML = "";
    storesList.forEach(s=>{
        const d = document.createElement("div");
        d.className = "card";
        d.innerText = s;
        d.onclick = ()=>renderProducts("stores", p=>p.store===s);
        c.appendChild(d);
    });
}

function showFavorites(){
    showSection("favorites");
    renderProducts("favorites", p=>favorites.includes(p.id));
}

function showSection(id,el){
    ["favorites","all","available","stores"].forEach(s=>{
        document.getElementById(s).style.display="none";
    });
    document.getElementById(id).style.display="grid";
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    if(el) el.classList.add("active");

    if(id === "stores"){
        document.getElementById("categories").style.display = "none";
    } else {
        document.getElementById("categories").style.display = "flex";
    }

    if(id==="stores") renderStores();
    else if(id==="all") renderProducts("all");
    else if(id==="available")
    renderProducts("available", p => isAvailable(p));

}

/* ===== Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª ===== */
function renderCategories() {
    const categoriesDiv = document.getElementById("categories");
    categoriesDiv.innerHTML = "";

    const categoriesList = [...new Set(products.map(p => p.category).filter(c => c))];

    categoriesList.forEach(cat => {
        const btn = document.createElement("div");
        btn.className = "category-btn";
        btn.innerText = cat;
        btn.onclick = () => filterByCategory(cat);
        categoriesDiv.appendChild(btn);
    });
}

renderCategories();
renderProducts("all");
</script>

</body>
</html>
