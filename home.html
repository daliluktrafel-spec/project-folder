<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ù…Ù†ØµØ© Ù…ØªØ§Ø¬Ø± Ø§Ù„Ø¨Ù„Ø§Ø¯</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
    margin: 0;
    font-family: "Segoe UI", Tahoma, Arial, sans-serif;
    background: linear-gradient(to bottom,#f2f2f2 0%,#4a6cf7 25%,#6a1b9a 75%,#f2f2f2 100%);
    color: #333;
}

.header {
    background: #6a1b9a;
    padding: 20px;
    text-align: center;
    font-size: 24px;
    font-weight: bold;
    color: white;
    position: relative;
}

/* Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù…ÙØ¶Ù„Ø© */
.fav-top {
    position: absolute;
    left: 15px;
    top: 15px;
    background: white;
    color: #e53935;
    padding: 6px 12px;
    border-radius: 20px;
    font-weight: bold;
    cursor: pointer;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}

.container {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
    padding: 20px;
}

.card {
    background: white;
    border-radius: 15px;
    padding: 15px;
    text-align: center;
    box-shadow: 0 8px 20px rgba(0,0,0,0.2);
    cursor: pointer;
    display: flex;
    flex-direction: column;
}

.product-img {
    width: 100%;
    aspect-ratio: 1 / 1;
    border-radius: 12px;
    background-size: contain;
    background-position: center;
    background-repeat: no-repeat;
    margin-bottom: 10px;
}

.product-name { font-weight: bold; font-size: 16px; }
.product-price { color: #e53935; font-weight: bold; }
.product-store { color: #1e88e5; font-size: 14px; }
.product-status { color: #6a1b9a; font-size: 14px; }

.actions {
    display: flex;
    gap: 8px;
    margin-top: auto;
}

.btn-order {
    flex: 1;
    padding: 10px;
    border: none;
    border-radius: 10px;
    background: linear-gradient(45deg,#6a1b9a,#3949ab);
    color: white;
    font-weight: bold;
    cursor: pointer;
}

.btn-fav {
    width: 45px;
    border: none;
    border-radius: 10px;
    background: #eee;
    font-size: 20px;
    cursor: pointer;
}

.btn-fav.active {
    background: #ffe5e5;
    color: #e53935;
}

.tabs {
    display: flex;
    justify-content: center;
    gap: 10px;
    padding: 15px;
    position: fixed;
    bottom: 0;
    width: 100%;
    background: #ffffffcc;
}

.tab {
    padding: 10px 20px;
    border-radius: 12px;
    border: 2px solid #6a1b9a;
    font-weight: bold;
    cursor: pointer;
    background: #f2f2f2;
}

.tab.active {
    background: #6a1b9a;
    color: white;
}

@media (max-width: 600px) {
    .container {
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
        padding: 15px;
    }
}
</style>
</head>

<body>

<div class="header" id="welcome">
    Ù…Ø±Ø­Ø¨Ø§ Ø¨Ùƒ
    <div class="fav-top" onclick="showFavorites()">â¤ï¸ <span id="favCount">0</span></div>
</div>

<div style="padding:15px;text-align:center;">
    <input type="text" id="searchInput" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬ Ø£Ùˆ Ù…ØªØ¬Ø±..." onkeyup="smartSearch()"
    style="width:90%;max-width:400px;padding:12px;border-radius:12px;border:1px solid #ccc;font-size:16px;">
</div>

<div id="favorites" class="container" style="display:none;"></div>
<div id="all" class="container"></div>
<div id="available" class="container" style="display:none;"></div>
<div id="stores" class="container" style="display:none;"></div>

<div class="tabs">
    <div class="tab active" onclick="showSection('all',this)">ÙƒÙ„ Ø§Ù„Ø¨Ø¶Ø§Ø¦Ø¹</div>
    <div class="tab" onclick="showSection('available',this)">Ø§Ù„Ù…ØªÙˆÙØ±</div>
    <div class="tab" onclick="showSection('stores',this)">Ø§Ù„Ù…ØªØ§Ø¬Ø±</div>
</div>

<script src="products.js"></script>
<script>
const userName = localStorage.getItem("userName") || "Ù…Ø³ØªØ®Ø¯Ù…";
const userRegion = localStorage.getItem("userRegion") || "";
document.getElementById("welcome").childNodes[0].nodeValue =
`Ù…Ø±Ø­Ø¨Ù‹Ø§ ${userName} Ù…Ù† ${userRegion}`;

let favorites = JSON.parse(localStorage.getItem("favorites") || "[]");
saveFav();

function saveFav(){
    localStorage.setItem("favorites", JSON.stringify(favorites));
    document.getElementById("favCount").innerText = favorites.length;
}

const storesList = [...new Set(products.map(p => p.store))];

function renderProducts(containerId, filter = () => true){
    const c = document.getElementById(containerId);
    c.innerHTML = "";
    products.filter(filter).forEach(p=>{
        const favActive = favorites.includes(p.id);
        const d = document.createElement("div");
        d.className = "card";
        d.onclick = ()=>location.href=`product.html?productId=${p.id}`;
        d.innerHTML = `
            <div class="product-img" style="background-image:url('${p.image}')"></div>
            <div class="product-name">${p.name}</div>
            <div class="product-price">${p.price}</div>
            <div class="product-store">${p.store}</div>
            <div class="product-status">${p.status}</div>
            <div class="actions">
                <button class="btn-order" onclick="order('${p.name}','${p.price}','${p.store}',event)">Ø§Ø·Ù„Ø¨</button>
                <button class="btn-fav ${favActive?'active':''}" onclick="toggleFav(${p.id},event)">â¤ï¸</button>
            </div>
        `;
        c.appendChild(d);
    });
}

function renderStores(){
    const c = document.getElementById("stores");
    c.innerHTML = "";
    storesList.forEach(s => {
        const div = document.createElement("div");
        div.className = "card";
        div.innerText = s;
        div.onclick = () => renderProducts("stores", p => p.store === s);
        c.appendChild(div);
    });
}

function toggleFav(id,e){
    e.stopPropagation();
    favorites = favorites.includes(id)
        ? favorites.filter(f=>f!==id)
        : [id, ...favorites];
    saveFav();
    renderProducts("all");
}

function showFavorites(){
    showSection("favorites");
    renderProducts("favorites", p=>favorites.includes(p.id));
}

function order(name,price,store,e){
    e.stopPropagation();
    const msg=`Ø§Ù„Ø§Ø³Ù…:${userName}%0AØ§Ù„Ù…Ù†Ø·Ù‚Ø©:${userRegion}%0AØ§Ù„Ù…Ù†ØªØ¬:${name}%0AØ§Ù„Ø³Ø¹Ø±:${price}%0AØ§Ù„Ù…ØªØ¬Ø±:${store}`;
    window.open(`https://wa.me/967774257557?text=${msg}`,"_blank");
}

function showSection(id,el){
    ["favorites","all","available","stores"].forEach(s=>{
        document.getElementById(s).style.display="none";
    });
    document.getElementById(id).style.display="grid";
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    if(el) el.classList.add("active");

    // Ø¥Ø°Ø§ Ø§Ø®ØªØ±Ù†Ø§ Ù‚Ø³Ù… Ø§Ù„Ù…ØªØ§Ø¬Ø± Ù†Ø¹Ø±Ø¶ Ø§Ù„Ù…ØªØ§Ø¬Ø±
    if(id === "stores") renderStores();
    // Ø¥Ø°Ø§ Ø§Ø®ØªØ±Ù†Ø§ Ø£ÙŠ Ù‚Ø³Ù… Ù…Ù†ØªØ¬Ø§Øª Ù†Ø¹ÙŠØ¯ ÙƒÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¨Ø´ÙƒÙ„ ÙƒØ§Ù…Ù„
    else if(id === "all") renderProducts("all");
    else if(id === "available") renderProducts("available", p => p.status === "Ù…ØªÙˆÙØ±");
    else if(id === "favorites") renderProducts("favorites", p => favorites.includes(p.id));
}

function normalizeArabic(text) {
    return text.toLowerCase()
        .replace(/Ø£|Ø¥|Ø¢/g, "Ø§")
        .replace(/Ø©/g, "Ù‡")
        .replace(/Ù‰/g, "ÙŠ")
        .replace(/Ø¤|Ø¦/g, "Ùˆ")
        .replace(/[^Ø¡-ÙŠ0-9\s]/g, "");
}

function smartSearch() {
    const q = normalizeArabic(document.getElementById("searchInput").value);
    const visibleSection = document.querySelector('.container[style*="display: grid"]')?.id || "all";

    if (!q) {
        // Ø¹Ø±Ø¶ ÙƒØ§Ù…Ù„ Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø³Ù…
        showSection(visibleSection);
        return;
    }

    if(visibleSection === "stores") {
        // ØªØµÙÙŠØ© Ø§Ù„Ù…ØªØ§Ø¬Ø± Ø­Ø³Ø¨ Ø§Ù„Ø§Ø³Ù…
        const c = document.getElementById("stores");
        c.innerHTML = "";
        storesList.filter(s => normalizeArabic(s).includes(q)).forEach(s => {
            const div = document.createElement("div");
            div.className = "card";
            div.innerText = s;
            div.onclick = () => renderProducts("stores", p => p.store === s);
            c.appendChild(div);
        });
    } else {
        const containerId = visibleSection;
        renderProducts(containerId, p =>
            normalizeArabic(p.name).includes(q) ||
            normalizeArabic(p.store).includes(q) ||
            normalizeArabic(p.price).includes(q)
        );
    }
}

// Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
renderProducts("all");
renderProducts("available", p => p.status === "Ù…ØªÙˆÙØ±");

</script>

</body>
</html>
